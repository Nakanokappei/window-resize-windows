name: Build MSIX

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore WindowResize/WindowResize.csproj

      - name: Publish (self-contained, win-x64)
        run: |
          dotnet publish WindowResize/WindowResize.csproj `
            -c Release `
            -r win-x64 `
            --self-contained `
            -p:PublishSingleFile=false

      - name: Prepare MSIX layout
        shell: pwsh
        run: |
          $publishDir = "WindowResize/bin/Release/net8.0-windows10.0.17763.0/win-x64/publish"
          $layoutDir  = "msix_layout"

          New-Item -ItemType Directory -Path $layoutDir -Force | Out-Null

          # Copy all published files
          Copy-Item -Path "$publishDir/*" -Destination $layoutDir -Recurse -Force

          # Move AppxManifest.xml and Assets from Package/ to root
          Copy-Item -Path "$layoutDir/Package/AppxManifest.xml" -Destination "$layoutDir/AppxManifest.xml" -Force
          New-Item -ItemType Directory -Path "$layoutDir/Assets" -Force | Out-Null
          Copy-Item -Path "$layoutDir/Package/Assets/*" -Destination "$layoutDir/Assets/" -Force

          # Remove the nested Package directory
          Remove-Item -Path "$layoutDir/Package" -Recurse -Force

          # Patch version from tag (if tag push)
          if ($env:GITHUB_REF -match '^refs/tags/v(\d+\.\d+)') {
            $version = $Matches[1] + ".0.0"
            $manifest = "$layoutDir/AppxManifest.xml"
            (Get-Content $manifest) -replace 'Version="[\d.]+"', "Version=`"$version`"" |
              Set-Content $manifest
            Write-Host "Patched manifest version to $version"
          }

      - name: Create MSIX package
        shell: pwsh
        run: |
          # Find makeappx.exe from Windows SDK
          $sdkBin = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\10.*\x64\makeappx.exe" |
                    Sort-Object FullName |
                    Select-Object -Last 1
          Write-Host "Using: $($sdkBin.FullName)"

          & $sdkBin.FullName pack /d msix_layout /p WindowResize.msix /o
          if ($LASTEXITCODE -ne 0) { throw "MakeAppx failed" }

          Write-Host "MSIX size: $((Get-Item WindowResize.msix).Length / 1MB) MB"

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: WindowResize-msix
          path: WindowResize.msix

      - name: Publish to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: WindowResize.msix
